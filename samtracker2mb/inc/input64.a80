; INPUT myslim od Shreka z MB commandera
; 64 znakov na riadok
; vlastny font

; IN: hx=dlzka retazca
; OUT: hl=vysledok (C=cisla, NC=ostatne znaky)

inpbuff:	equ	23296
inputpos:	equ	#0626		;suradnice vypisu x,y

		call	inputt
		call	deci
		ret

deci:		ld	de,inpbuff
		ld	hl,0
deci1:		ld	a,(de)
		sub	"0"
		ret	c
		cp	10
		ret	nc
		inc	de
		add	hl,hl
		ld	c,l
		ld	b,h
		add	hl,hl
		add	hl,hl
		add	hl,bc
		ld	c,a
		ld	b,0
		add	hl,bc
		jr	deci1

inputt:		ld	hl,inpbuff
		ld	b,hx
inputt1:	ld	(hl),32
		inc	l
		djnz	inputt1
		xor	a
		ld	(hl),a
		ld	(cursor+1),a
inputt2:	ld	b,hx
		ld	hl,inputpos
		ld	de,inpbuff
cursor:		ld	c,0
inputt3:	ld	a,e
		push	bc
		cp	c
		jr	nz,inxxx
		ld	a,c
		or	a
		ld	b,">"
		jr	z,curtv2
		ld	b,"_"
curtv2:		ld	a,b
		push	de
		call	char
		pop	de
inxxx:		ld	a,(de)
		push	de
		call	char
		pop	de
		inc	e
		pop	bc
		djnz	inputt3
		ld	a,e
		cp	c
		jr	nz,inxxx2
		ld	a,c
		cp	hx
		ld	b,"<"
		jr	z,curtv
		ld	b,"_"
curtv:		ld	a,b
		call	char
inxxx2:		ld	b,15
		call	wtky
inqqq:		call	keyscan
		jr	nz,inqqq
		ld	a,e
		inc	a
		jr	z,inqqq
		ld	a,d
		ld	hl,symtab
		cp	#18
		jr	z,insss
		ld	hl,capstab
		cp	#27
		jr	z,insss
		ld	hl,normtab
insss:		ld	d,0
		add	hl,de
		ld	a,(hl)
		or	a
		jr	z,inqqq
		cp	4
		ret	z
		cp	13
		ret	z
		cp	199
		jp	z,inputt
		ld	hl,inputt2
		push	hl
		ld	hl,cursor+1
		cp	8
		jr	z,cursleft
		cp	9
		jr	z,cursrght
		cp	12
		jr	z,backspace
		cp	15
		jr	z,delete
		cp	32
		ret	c
		cp	128
		ret	nc
		ex	af,af'
		ld	a,(hl)
		cp	hx
		ret	nc
		inc	(hl)
		ld	l,(hl)
		dec	l
		ld	h,inpbuff/256
insrt:		ld	a,(hl)
		or	a
		ret	z
		ex	af,af'
		ld	(hl),a
		inc	hl
		jr	insrt

cursleft:	ld	a,(hl)
		or	a
		ret	z
		dec	(hl)
		ret

cursrght:	ld	a,(hl)
		cp	hx
		ret	nc
		inc	(hl)
		ret

delete:		ld	a,(hl)
		cp	hx
		ret	nc
		inc	a
		jr	back2

backspace:	ld	a,(hl)
		or	a
		ret	z
		dec	(hl)
back2:		ld	l,a
		ld	h,inpbuff/256
		ld	e,l
		ld	d,h
		dec	e
del2:		ld	a,(hl)
		ldi
		or	a
		jr	nz,del2
		ex	de,hl
		dec	l
		ld	(hl)," "
		ret

wtky:		xor	a
		in	a,(254)
		cpl
		and	31
		ret	z
		ld	a,b
		or	a
		jr	z,wtky
		ld	de,768
wtk2:		ex	(sp),hl
		ex	(sp),hl
		dec	de
		ld	a,e
		or	d
		jr	nz,wtk2
		djnz	wtky
		ret

keyscan:	ld	l,47
		ld	de,65535
		ld	bc,65278
keyline:	in	a,(c)
		cpl
		and	31
		jr	z,keydone
		ld	h,a
		ld	a,l
key3keys:	inc	d
		ret	nz
keybits:	sub	8
		srl	h
		jr	nc,keybits
		ld	d,e
		ld	e,a
		jr	nz,key3keys
keydone:	dec	l
		rlc	b
		jr	c,keyline
		ld	a,d
		inc	a
		ret	z
		cp	40
		ret	z
		cp	25
		ret	z
		ld	a,e
		ld	e,d
		ld	d,a
		cp	24
		ret

symtab:		defm	"*^[&%>}/"
		defm	",-]'$<{?"
		defm	".+ï¿½(#"
		defb	200
		defm	"\\L"
		defb	0
		defm	"=;)@"
		defb	201
		defm	"|:"
		defb	32,13,34
		defm	"_!"
		defb	199
		defb	"~",0

capstab:	defm	"BHY"
		defb	10,8
		defm	"TGV"
		defm	"NJU"
		defb	11,5
		defm	"RFC"
		defm	"MKI"
		defb	9,4
		defm	"EDX"
		defb	2
		defm	"LO"
		defb	15,6
		defm	"WSZ"
		defb	1,13,"P"
		defb	12,7
		defm	"QA"

normtab:	defm	"bhy65tgv"
		defm	"nju74rfc"
		defm	"mki83edx"
		defb	0
		defm	"lo92wsz"
		defb	32,13
		defm	"p01qa"
		defb	0

char:		cp	32
		jr	c,unchar
		cp	128
		jr	nc,unchar
		jr	charoki
unchar:		ld	a,32
charoki:	push	hl
		ex	af,af'
		call	adrset
		jp	z,secnd2
		ex	af,af'
		ex	de,hl
		add	a,a
		ld	l,a
		ld	h,0
		add	hl,hl
		add	hl,hl
		ld	bc,font-256
		add	hl,bc
		ex	de,hl
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%11110000
		ld	(hl),a
		pop	hl
		inc	l
		ret

secnd2:		ex	af,af'
		ex	de,hl
		add	a,a
		ld	l,a
		ld	h,0
		add	hl,hl
		add	hl,hl
		ld	bc,font-256
		add	hl,bc
		ex	de,hl
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	e
		inc	h
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	h
		inc	e
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	h
		inc	e
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	h
		inc	e
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	h
		inc	e
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		inc	h
		inc	e
		ld	a,(de)
		and	%00001111
		or	(hl)
		ld	(hl),a
		pop	hl
		inc	l
		ret

adrset:		ld	a,h
		push	hl
		and	%00011000
		or	%01000000
		ld	l,0
		rr	h
		rr	l
		rr	h
		rr	l
		rr	h
		rr	l
		ld	h,a
		pop	bc
		bit	0,c
		ld	a,1
		jr	z,cont
		xor	a
cont:		srl	c
		ld	b,0
		add	hl,bc
		or	a
		ret


		align	256
		
font:		defw	0
		defw	0
		defw	0
		defw	0
		defw	17408
		defw	17476
		defw	68
		defw	68
		defw	43520
		defw	170
		defw	0
		defw	0
		defw	0
		defw	61098
		defw	61098
		defw	170
		defw	0
		defw	52462
		defw	26350
		defw	238
		defw	43520
		defw	17442
		defw	34884
		defw	170
		defw	17408
		defw	17578
		defw	61098
		defw	102
		defw	17408
		defw	34884
		defw	0
		defw	0
		defw	26112
		defw	17476
		defw	17476
		defw	102
		defw	52224
		defw	17476
		defw	17476
		defw	204
		defw	0
		defw	60996
		defw	60996
		defw	68
		defw	0
		defw	17476
		defw	17646
		defw	68
		defw	0
		defw	0
		defw	17476
		defw	136
		defw	0
		defw	0
		defw	238
		defw	0
		defw	0
		defw	0
		defw	52224
		defw	204
		defw	8704
		defw	17442
		defw	34884
		defw	136
		defw	60928
		defw	43690
		defw	43690
		defw	238
		defw	17408
		defw	17612
		defw	17476
		defw	238
		defw	60928
		defw	60962
		defw	43656
		defw	238
		defw	60928
		defw	26146
		defw	43554
		defw	238
		defw	34816
		defw	43690
		defw	8942
		defw	34
		defw	60928
		defw	61064
		defw	43554
		defw	238
		defw	60928
		defw	61064
		defw	43690
		defw	238
		defw	60928
		defw	8874
		defw	8738
		defw	34
		defw	60928
		defw	61098
		defw	43690
		defw	238
		defw	60928
		defw	61098
		defw	43554
		defw	238
		defw	0
		defw	17408
		defw	17408
		defw	0
		defw	0
		defw	17408
		defw	17408
		defw	136
		defw	0
		defw	17442
		defw	17544
		defw	34
		defw	0
		defw	60928
		defw	60928
		defw	0
		defw	0
		defw	17544
		defw	17442
		defw	136
		defw	60928
		defw	26282
		defw	68
		defw	68
		defw	17408
		defw	61098
		defw	35054
		defw	102
		defw	60928
		defw	61098
		defw	43690
		defw	170
		defw	60928
		defw	52394
		defw	43690
		defw	238
		defw	60928
		defw	34986
		defw	43656
		defw	238
		defw	52224
		defw	43690
		defw	43690
		defw	204
		defw	60928
		defw	52360
		defw	34952
		defw	238
		defw	60928
		defw	52360
		defw	34952
		defw	136
		defw	60928
		defw	34986
		defw	43758
		defw	238
		defw	43520
		defw	61098
		defw	43690
		defw	170
		defw	60928
		defw	17476
		defw	17476
		defw	238
		defw	60928
		defw	8738
		defw	43554
		defw	238
		defw	43520
		defw	52394
		defw	43690
		defw	170
		defw	34816
		defw	34952
		defw	43656
		defw	238
		defw	43520
		defw	43758
		defw	43690
		defw	170
		defw	60928
		defw	43690
		defw	43690
		defw	170
		defw	60928
		defw	43690
		defw	43690
		defw	238
		defw	60928
		defw	61098
		defw	34952
		defw	136
		defw	60928
		defw	43690
		defw	61098
		defw	238
		defw	60928
		defw	61098
		defw	43724
		defw	170
		defw	60928
		defw	61064
		defw	43554
		defw	238
		defw	60928
		defw	17476
		defw	17476
		defw	68
		defw	43520
		defw	43690
		defw	43690
		defw	238
		defw	43520
		defw	43690
		defw	43690
		defw	68
		defw	43520
		defw	61098
		defw	61166
		defw	68
		defw	43520
		defw	17578
		defw	43690
		defw	170
		defw	43520
		defw	43690
		defw	8942
		defw	238
		defw	60928
		defw	60962
		defw	43656
		defw	238
		defw	26112
		defw	17476
		defw	17476
		defw	102
		defw	34816
		defw	17544
		defw	8772
		defw	34
		defw	26112
		defw	8738
		defw	8738
		defw	102
		defw	17408
		defw	17646
		defw	17476
		defw	68
		defw	0
		defw	0
		defw	0
		defw	65280
		defw	8704
		defw	26180
		defw	17476
		defw	238
		defw	0
		defw	8942
		defw	43758
		defw	238
		defw	34816
		defw	61064
		defw	43690
		defw	238
		defw	0
		defw	35054
		defw	34952
		defw	238
		defw	8704
		defw	60962
		defw	43690
		defw	238
		defw	0
		defw	43758
		defw	35054
		defw	238
		defw	26112
		defw	52360
		defw	34952
		defw	136
		defw	0
		defw	43758
		defw	8942
		defw	238
		defw	34816
		defw	61064
		defw	43690
		defw	170
		defw	17408
		defw	52224
		defw	17476
		defw	238
		defw	8704
		defw	8704
		defw	43554
		defw	238
		defw	34816
		defw	43656
		defw	43724
		defw	170
		defw	34816
		defw	34952
		defw	34952
		defw	102
		defw	0
		defw	61098
		defw	43690
		defw	170
		defw	0
		defw	43758
		defw	43690
		defw	170
		defw	0
		defw	43758
		defw	43690
		defw	238
		defw	0
		defw	43758
		defw	35054
		defw	136
		defw	0
		defw	43758
		defw	8942
		defw	34
		defw	0
		defw	35054
		defw	34952
		defw	136
		defw	0
		defw	35054
		defw	8942
		defw	238
		defw	17408
		defw	17646
		defw	17476
		defw	102
		defw	0
		defw	43690
		defw	43690
		defw	238
		defw	0
		defw	43690
		defw	43690
		defw	68
		defw	0
		defw	43690
		defw	61166
		defw	238
		defw	0
		defw	43690
		defw	43588
		defw	170
		defw	0
		defw	43690
		defw	8942
		defw	204
		defw	0
		defw	8942
		defw	35054
		defw	238
		defw	26112
		defw	34884
		defw	17476
		defw	102
		defw	17408
		defw	17476
		defw	17476
		defw	68
		defw	52224
		defw	8772
		defw	17476
		defw	204
		defw	43520
		defw	170
		defw	0
		defw	0
		defw	60928
		defw	61166
		defw	61166
		defw	238
